#!/usr/bin/env python3
"""Play a role recording from 1s before a given offset."""
from __future__ import annotations

from dataclasses import dataclass
import logging
from pathlib import Path
import subprocess
import sys


@dataclass
class AudioCheck:
    role: str
    offset_ms: int
    base_dir: Path

    def run(self) -> int:
        if self.offset_ms < 0:
            raise RuntimeError("Offset must be a non-negative integer (ms)")
        start_ms = max(0, self.offset_ms - 1000)
        start_seconds = start_ms / 1000.0
        audio_path = self.base_dir / "plays" / "androcles" / "recordings" / f"{self.role}.wav"
        if not audio_path.exists():
            raise RuntimeError(f"Recording not found: {audio_path}")
        logging.info(
            "Starting ffplay for %s at %dms (offset %dms)",
            audio_path,
            start_ms,
            self.offset_ms,
        )
        return subprocess.call(
            [
                "ffplay",
                "-nodisp",
                "-autoexit",
                "-loglevel",
                "error",
                "-ss",
                f"{start_seconds:.3f}",
                "-i",
                str(audio_path),
            ]
        )

    @classmethod
    def from_argv(cls, argv: list[str]) -> "AudioCheck":
        if len(argv) != 2:
            raise RuntimeError("Usage: audiocheck ROLE OFFSET_MS")
        role = argv[0]
        offset_ms = int(argv[1])
        base_dir = Path(__file__).resolve().parent
        return cls(role=role, offset_ms=offset_ms, base_dir=base_dir)


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, format="%(message)s")
    try:
        checker = AudioCheck.from_argv(sys.argv[1:])
        raise SystemExit(checker.run())
    except KeyboardInterrupt:
        raise SystemExit(130)
