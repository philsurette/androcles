#!/usr/bin/env python3
"""Play a role recording from a time offset relative to a given position."""
from __future__ import annotations

from dataclasses import dataclass
import logging
from pathlib import Path
import subprocess
import sys

ROOT = Path(__file__).resolve().parent
SRC = ROOT / "src"
if str(SRC) not in sys.path:
    sys.path.insert(0, str(SRC))

from play_config import PlayConfig

@dataclass
class AudioCheck:
    role: str
    offset_ms: int
    adjust_seconds: float
    base_dir: Path

    def run(self) -> int:
        if self.offset_ms < 0:
            raise RuntimeError("Offset must be a non-negative integer (ms)")
        adjust_ms = int(round(self.adjust_seconds * 1000))
        start_ms = max(0, self.offset_ms + adjust_ms)
        start_seconds = start_ms / 1000.0
        config = PlayConfig.load(self.base_dir)
        audio_path = (
            self.base_dir
            / "plays"
            / config.play_id
            / "recordings"
            / f"{self.role}.wav"
        )
        if not audio_path.exists():
            raise RuntimeError(f"Recording not found: {audio_path}")
        logging.info(
            "Starting ffplay for %s at %dms (offset %dms, adjust %.3fs)",
            audio_path,
            start_ms,
            self.offset_ms,
            self.adjust_seconds,
        )
        return subprocess.call(
            [
                "ffplay",
                "-nodisp",
                "-autoexit",
                "-loglevel",
                "error",
                "-ss",
                f"{start_seconds:.3f}",
                "-i",
                str(audio_path),
            ]
        )

    @classmethod
    def from_argv(cls, argv: list[str]) -> "AudioCheck":
        if len(argv) not in (2, 3):
            raise RuntimeError("Usage: audiocheck ROLE OFFSET_MS [ADJUST_SECONDS]")
        role = argv[0]
        offset_ms = int(argv[1])
        adjust_seconds = float(argv[2]) if len(argv) == 3 else -1.0
        base_dir = ROOT
        return cls(
            role=role,
            offset_ms=offset_ms,
            adjust_seconds=adjust_seconds,
            base_dir=base_dir,
        )


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, format="%(message)s")
    try:
        checker = AudioCheck.from_argv(sys.argv[1:])
        raise SystemExit(checker.run())
    except KeyboardInterrupt:
        raise SystemExit(130)
